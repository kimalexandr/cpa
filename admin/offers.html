<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Офферы — Админ — RealCPA Hub</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="admin-page">
    <header class="admin-header">
        <div class="admin-header-inner">
            <a href="../index.html" class="admin-logo"><i class="fas fa-link"></i> RealCPA Hub</a>
            <span class="admin-title">Админ-панель</span>
            <div class="admin-header-user">
                <span class="admin-user-name" id="adminUserName"></span>
                <a href="../index.html" class="admin-logout" id="adminLogout">Выход</a>
            </div>
        </div>
    </header>

    <div class="admin-layout">
        <aside class="admin-sidebar">
            <nav class="admin-nav">
                <a href="index.html" class="admin-nav-link"><i class="fas fa-tachometer-alt"></i> Главная</a>
                <a href="users.html" class="admin-nav-link"><i class="fas fa-users"></i> Пользователи</a>
                <a href="offers.html" class="admin-nav-link active"><i class="fas fa-briefcase"></i> Офферы</a>
                <a href="categories.html" class="admin-nav-link"><i class="fas fa-folder"></i> Категории</a>
                <a href="geography.html" class="admin-nav-link"><i class="fas fa-globe"></i> География</a>
                <a href="moderation.html" class="admin-nav-link"><i class="fas fa-clipboard-check"></i> Модерация</a>
                <a href="finance.html" class="admin-nav-link"><i class="fas fa-wallet"></i> Финансы</a>
                <a href="settings.html" class="admin-nav-link"><i class="fas fa-cog"></i> Настройки</a>
                <a href="logs.html" class="admin-nav-link"><i class="fas fa-history"></i> Логи</a>
            </nav>
        </aside>

        <main class="admin-main">
            <div class="admin-toolbar">
                <h1 class="admin-page-title">Офферы</h1>
            </div>
            <div class="admin-filters">
                <input type="text" id="offerSearch" placeholder="Поиск по названию">
                <select id="offerStatusFilter">
                    <option value="">Все статусы</option>
                    <option value="draft">Черновик</option>
                    <option value="active">Активен</option>
                    <option value="paused">Приостановлен</option>
                    <option value="closed">Закрыт</option>
                </select>
                <button type="button" class="btn btn-primary" id="offerApplyFilters">Применить</button>
            </div>
            <div class="admin-table-wrap">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Название</th>
                            <th>Поставщик</th>
                            <th>Категория</th>
                            <th>Статус</th>
                            <th>Ставка</th>
                            <th>Рейтинг</th>
                            <th>Отзывов</th>
                            <th>Обновлён</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="offersTableBody">
                        <tr><td colspan="10">Загрузка...</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script src="../api.js"></script>
    <script>
    (function() {
        if (typeof window.RealCPA === 'undefined' || !window.RealCPA.isLoggedIn() || window.RealCPA.getRole() !== 'admin') {
            window.location.href = '../login.html?redirect=' + encodeURIComponent('admin/offers.html');
            return;
        }
        var user = window.RealCPA.getUser();
        document.getElementById('adminUserName').textContent = (user && (user.name || user.email)) || 'Админ';
        document.getElementById('adminLogout').addEventListener('click', function(e) { e.preventDefault(); window.RealCPA.clearAuth(); window.location.href = '../index.html'; });

        function loadOffers() {
            var status = document.getElementById('offerStatusFilter').value;
            var search = document.getElementById('offerSearch').value.trim();
            var params = {};
            if (status) params.status = status;
            if (search) params.search = search;
            window.RealCPA.admin.offers(params)
                .then(function(list) {
                    var tbody = document.getElementById('offersTableBody');
                    if (!list.length) { tbody.innerHTML = '<tr><td colspan="10">Нет офферов</td></tr>'; return; }
                    var statusLabels = { draft: 'Черновик', active: 'Активен', paused: 'Приостановлен', closed: 'Закрыт' };
                    tbody.innerHTML = list.map(function(o) {
                        var cat = o.category ? o.category.name : '—';
                        var sup = o.supplier ? (o.supplier.name || o.supplier.email) : '—';
                        var rate = o.payoutAmount != null ? o.payoutAmount + ' ' + (o.currency || '₽') : '—';
                        var rating = o.rating != null ? o.rating : '—';
                        var reviews = o.reviewsCount != null ? o.reviewsCount : '—';
                        var updated = o.updatedAt ? new Date(o.updatedAt).toLocaleDateString('ru') : '—';
                        var statusCl = o.status === 'active' ? 'admin-badge-active' : (o.status === 'draft' ? 'admin-badge-pending' : 'admin-badge-blocked');
                        var actions = '';
                        if (o.status === 'draft') {
                            actions = '<button type="button" class="btn btn-primary btn-sm admin-offer-confirm" data-offer-id="' + (o.id || '') + '" title="Активировать оффер">Подтвердить</button> ';
                        }
                        actions += '<button type="button" class="btn btn-secondary btn-sm admin-offer-rating" data-offer-id="' + (o.id || '') + '" data-rating="' + (o.rating != null ? o.rating : '') + '" data-reviews="' + (o.reviewsCount != null ? o.reviewsCount : '') + '" title="Изм. рейтинг и отзывы">Рейтинг</button>';
                        return '<tr><td>' + (o.id || '').slice(0, 8) + '…</td><td><a href="../offer.html?id=' + encodeURIComponent(o.id) + '">' + (o.title || '—').slice(0, 40) + '</a></td><td>' + sup + '</td><td>' + cat + '</td><td><span class="admin-badge ' + statusCl + '">' + (statusLabels[o.status] || o.status) + '</span></td><td>' + rate + '</td><td>' + rating + '</td><td>' + reviews + '</td><td>' + updated + '</td><td>' + actions + '</td></tr>';
                    }).join('');
                    tbody.querySelectorAll('.admin-offer-confirm').forEach(function(btn) {
                        btn.addEventListener('click', function() {
                            var id = this.getAttribute('data-offer-id');
                            if (!id) return;
                            this.disabled = true;
                            this.textContent = '…';
                            window.RealCPA.admin.setOfferStatus(id, 'active').then(function() {
                                loadOffers();
                            }).catch(function(err) {
                                alert((err && err.message) || 'Ошибка подтверждения');
                                loadOffers();
                            });
                        });
                    });
                    tbody.querySelectorAll('.admin-offer-rating').forEach(function(btn) {
                        btn.addEventListener('click', function() {
                            var id = this.getAttribute('data-offer-id');
                            var curRating = this.getAttribute('data-rating') || '';
                            var curReviews = this.getAttribute('data-reviews') || '';
                            var r = prompt('Рейтинг (1–5, например 4.8):', curRating);
                            if (r === null) return;
                            var rev = prompt('Количество отзывов:', curReviews);
                            if (rev === null) return;
                            var ratingNum = r.trim() === '' ? null : parseFloat(r.replace(',', '.'));
                            var reviewsNum = rev.trim() === '' ? null : parseInt(rev, 10);
                            if (ratingNum !== null && (ratingNum < 0 || ratingNum > 5 || isNaN(ratingNum))) { alert('Рейтинг от 0 до 5'); return; }
                            if (reviewsNum !== null && (reviewsNum < 0 || isNaN(reviewsNum))) { alert('Число отзывов — целое неотрицательное'); return; }
                            var payload = {};
                            if (ratingNum !== null || r.trim() === '') payload.rating = ratingNum;
                            if (reviewsNum !== null || rev.trim() === '') payload.reviewsCount = reviewsNum;
                            if (Object.keys(payload).length === 0) return;
                            btn.disabled = true;
                            window.RealCPA.admin.updateOffer(id, payload).then(function() {
                                loadOffers();
                            }).catch(function(err) {
                                alert((err && err.message) || 'Ошибка сохранения');
                                loadOffers();
                            }).finally(function() { btn.disabled = false; });
                        });
                    });
                })
                .catch(function(err) {
                    document.getElementById('offersTableBody').innerHTML = '<tr><td colspan="10">Ошибка: ' + (err.message || 'загрузка') + '</td></tr>';
                });
        }
        document.getElementById('offerApplyFilters').addEventListener('click', loadOffers);
        loadOffers();
    })();
    </script>
</body>
</html>
