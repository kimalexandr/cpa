<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>География — Админ — RealCPA Hub</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="admin-page">
    <header class="admin-header">
        <div class="admin-header-inner">
            <a href="../index.html" class="admin-logo"><i class="fas fa-link"></i> RealCPA Hub</a>
            <span class="admin-title">Админ-панель</span>
            <div class="admin-header-user">
                <span class="admin-user-name" id="adminUserName"></span>
                <a href="../index.html" class="admin-logout" id="adminLogout">Выход</a>
            </div>
        </div>
    </header>
    <div class="admin-layout">
        <aside class="admin-sidebar">
            <nav class="admin-nav">
                <a href="index.html" class="admin-nav-link"><i class="fas fa-tachometer-alt"></i> Главная</a>
                <a href="users.html" class="admin-nav-link"><i class="fas fa-users"></i> Пользователи</a>
                <a href="offers.html" class="admin-nav-link"><i class="fas fa-briefcase"></i> Офферы</a>
                <a href="categories.html" class="admin-nav-link"><i class="fas fa-folder"></i> Категории</a>
                <a href="geography.html" class="admin-nav-link active"><i class="fas fa-globe"></i> География</a>
                <a href="moderation.html" class="admin-nav-link"><i class="fas fa-clipboard-check"></i> Модерация</a>
                <a href="finance.html" class="admin-nav-link"><i class="fas fa-wallet"></i> Финансы</a>
                <a href="settings.html" class="admin-nav-link"><i class="fas fa-cog"></i> Настройки</a>
                <a href="logs.html" class="admin-nav-link"><i class="fas fa-history"></i> Логи</a>
            </nav>
        </aside>
        <main class="admin-main">
            <div class="admin-toolbar">
                <h1 class="admin-page-title">География (локации)</h1>
                <button type="button" class="btn btn-primary" id="btnAddLocation">
                    <i class="fas fa-plus"></i> Добавить локацию
                </button>
            </div>
            <p class="admin-card-label" style="margin-bottom:1rem">Справочник: страна → округ → регион → город. is_active скрывает из виджета выбора, не ломая историю. Экспорт/импорт JSON.</p>
            <div class="admin-filters" style="margin-bottom:1rem">
                <input type="text" id="locationSearch" placeholder="Поиск по названию">
                <select id="locationLevelFilter">
                    <option value="">Все уровни</option>
                    <option value="1">1 — страна</option>
                    <option value="2">2 — округ</option>
                    <option value="3">3 — регион</option>
                    <option value="4">4 — город</option>
                </select>
                <select id="locationTypeFilter">
                    <option value="">Все типы</option>
                    <option value="country">country</option>
                    <option value="federal_district">federal_district</option>
                    <option value="region">region</option>
                    <option value="city">city</option>
                </select>
                <button type="button" class="btn btn-primary" id="btnApplyFilters">Применить</button>
                <button type="button" class="btn btn-secondary" id="btnExportLocations">Экспорт JSON</button>
                <label class="btn btn-secondary" style="margin-bottom:0"><input type="file" id="importFile" accept=".json" style="display:none"> Импорт JSON</label>
            </div>
            <div class="admin-table-wrap">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Ур.</th>
                            <th>Название</th>
                            <th>Тип</th>
                            <th>Родитель</th>
                            <th>full_name</th>
                            <th>code</th>
                            <th>Офферов</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="locationsTableBody">
                        <tr><td colspan="9">Загрузка...</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <div class="modal" id="locationModal" style="display:none">
        <div class="modal-content" style="max-width:520px">
            <span class="modal-close" id="locationModalClose">&times;</span>
            <h2 id="locationModalTitle">Добавить локацию</h2>
            <form id="locationForm">
                <input type="hidden" id="locationId">
                <div class="form-group">
                    <label for="locationName">Название *</label>
                    <input type="text" id="locationName" class="form-control" required placeholder="Например: Амурская область">
                </div>
                <div class="form-group">
                    <label for="locationType">Тип *</label>
                    <select id="locationType" class="form-control" required>
                        <option value="country">country</option>
                        <option value="federal_district">federal_district</option>
                        <option value="region">region</option>
                        <option value="city">city</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="locationParent">Родитель</label>
                    <select id="locationParent" class="form-control">
                        <option value="">— корень (страна)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="locationLevel">Уровень (1–4)</label>
                    <input type="number" id="locationLevel" class="form-control" min="1" max="4" value="1">
                </div>
                <div class="form-group">
                    <label for="locationFullName">full_name (для городов: «Город (Регион)»)</label>
                    <input type="text" id="locationFullName" class="form-control" placeholder="Опционально">
                </div>
                <div class="form-group">
                    <label for="locationCode">code (ISO/ФИАС)</label>
                    <input type="text" id="locationCode" class="form-control" placeholder="Опционально">
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="locationIsActive" checked> Активна (видна в выборе региона)</label>
                </div>
                <button type="submit" class="btn btn-primary">Сохранить</button>
                <button type="button" class="btn btn-secondary" id="locationFormCancel">Отмена</button>
            </form>
        </div>
    </div>

    <script src="../api.js"></script>
    <script>
    (function() {
        if (typeof window.RealCPA === 'undefined' || !window.RealCPA.isLoggedIn() || window.RealCPA.getRole() !== 'admin') {
            window.location.href = '../login.html?redirect=' + encodeURIComponent('admin/geography.html');
            return;
        }
        var user = window.RealCPA.getUser();
        document.getElementById('adminUserName').textContent = (user && (user.name || user.email)) || 'Админ';
        document.getElementById('adminLogout').addEventListener('click', function(e) { e.preventDefault(); window.RealCPA.clearAuth(); window.location.href = '../index.html'; });

        var modal = document.getElementById('locationModal');
        var form = document.getElementById('locationForm');
        var titleEl = document.getElementById('locationModalTitle');
        var locationsList = [];

        function loadLocations() {
            var params = {};
            var searchEl = document.getElementById('locationSearch');
            var levelEl = document.getElementById('locationLevelFilter');
            var typeEl = document.getElementById('locationTypeFilter');
            if (searchEl && searchEl.value.trim()) params.search = searchEl.value.trim();
            if (levelEl && levelEl.value) params.level = levelEl.value;
            if (typeEl && typeEl.value) params.type = typeEl.value;
            window.RealCPA.admin.locations(params)
                .then(function(list) {
                    locationsList = list;
                    var tbody = document.getElementById('locationsTableBody');
                    if (!list.length) {
                        tbody.innerHTML = '<tr><td colspan="9">Нет локаций. Добавьте первую или загрузите сид (npm run db:seed-locations).</td></tr>';
                        return;
                    }
                    tbody.innerHTML = list.map(function(l) {
                        var status = l.isActive !== false ? '<span class="admin-badge-active">Активна</span>' : '<span class="admin-badge-blocked">Скрыта</span>';
                        var full = (l.fullName || '').slice(0, 40);
                        if ((l.fullName || '').length > 40) full += '…';
                        var parentName = (l.parent && l.parent.name) ? escapeHtml(l.parent.name) : '—';
                        return '<tr data-id="' + l.id + '">' +
                            '<td>' + (l.level != null ? l.level : '—') + '</td>' +
                            '<td>' + escapeHtml(l.name) + '</td>' +
                            '<td><code>' + (l.type || '—') + '</code></td>' +
                            '<td>' + parentName + '</td>' +
                            '<td>' + escapeHtml(full) + '</td>' +
                            '<td>' + escapeHtml(l.code || '—') + '</td>' +
                            '<td>' + (l.offersCount != null ? l.offersCount : '—') + '</td>' +
                            '<td>' + status + '</td>' +
                            '<td><button type="button" class="btn btn-sm btn-secondary btn-edit-location" data-id="' + l.id + '">Изменить</button></td></tr>';
                    }).join('');
                    tbody.querySelectorAll('.btn-edit-location').forEach(function(btn) {
                        btn.addEventListener('click', function() { openEdit(this.getAttribute('data-id')); });
                    });
                })
                .catch(function(err) {
                    document.getElementById('locationsTableBody').innerHTML = '<tr><td colspan="9">Ошибка: ' + escapeHtml(err.message || 'загрузка') + '</td></tr>';
                });
        }
        function escapeHtml(s) {
            if (s == null) return '';
            var div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }
        function fillParentSelect(exceptId) {
            var sel = document.getElementById('locationParent');
            if (!sel) return;
            var opts = '<option value="">— корень (страна)</option>';
            locationsList.filter(function(x) { return x.id !== exceptId; }).forEach(function(x) {
                opts += '<option value="' + x.id + '">' + escapeHtml(x.name) + ' (' + (x.type || '') + ', ур.' + (x.level || 1) + ')</option>';
            });
            sel.innerHTML = opts;
        }
        function openAdd() {
            document.getElementById('locationId').value = '';
            document.getElementById('locationName').value = '';
            document.getElementById('locationType').value = 'region';
            document.getElementById('locationParent').value = '';
            document.getElementById('locationLevel').value = '3';
            document.getElementById('locationFullName').value = '';
            document.getElementById('locationCode').value = '';
            document.getElementById('locationIsActive').checked = true;
            fillParentSelect();
            titleEl.textContent = 'Добавить локацию';
            modal.style.display = 'flex';
        }
        function openEdit(id) {
            var l = locationsList.find(function(x) { return x.id === id; });
            if (!l) return;
            document.getElementById('locationId').value = l.id;
            document.getElementById('locationName').value = l.name || '';
            document.getElementById('locationType').value = l.type || 'region';
            document.getElementById('locationParent').value = l.parentId || '';
            document.getElementById('locationLevel').value = l.level != null ? l.level : 3;
            document.getElementById('locationFullName').value = l.fullName || '';
            document.getElementById('locationCode').value = l.code || '';
            document.getElementById('locationIsActive').checked = l.isActive !== false;
            fillParentSelect(l.id);
            titleEl.textContent = 'Изменить локацию';
            modal.style.display = 'flex';
        }
        function closeModal() {
            modal.style.display = 'none';
        }

        document.getElementById('btnAddLocation').addEventListener('click', openAdd);
        document.getElementById('locationModalClose').addEventListener('click', closeModal);
        document.getElementById('locationFormCancel').addEventListener('click', closeModal);
        modal.addEventListener('click', function(e) { if (e.target === modal) closeModal(); });

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            var id = document.getElementById('locationId').value;
            var data = {
                name: document.getElementById('locationName').value.trim(),
                type: document.getElementById('locationType').value,
                parentId: document.getElementById('locationParent').value || null,
                level: parseInt(document.getElementById('locationLevel').value, 10) || 1,
                fullName: document.getElementById('locationFullName').value.trim() || null,
                code: document.getElementById('locationCode').value.trim() || null,
                isActive: document.getElementById('locationIsActive').checked
            };
            if (!data.name || !data.type) { alert('Укажите название и тип'); return; }
            var promise = id ? window.RealCPA.admin.updateLocation(id, data) : window.RealCPA.admin.createLocation(data);
            promise
                .then(function() { closeModal(); loadLocations(); })
                .catch(function(err) { alert('Ошибка: ' + (err.message || 'сохранение')); });
        });

        document.getElementById('btnApplyFilters').addEventListener('click', loadLocations);
        document.getElementById('btnExportLocations').addEventListener('click', function() {
            window.RealCPA.admin.locations().then(function(list) {
                var clean = list.map(function(l) {
                    return { id: l.id, parentId: l.parentId, name: l.name, type: l.type, fullName: l.fullName, level: l.level, code: l.code, isActive: l.isActive };
                });
                var blob = new Blob([JSON.stringify(clean, null, 2)], { type: 'application/json' });
                var a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'locations.json';
                a.click();
                URL.revokeObjectURL(a.href);
            }).catch(function(err) { alert('Ошибка экспорта: ' + (err.message || '')); });
        });
        document.getElementById('importFile').addEventListener('change', function() {
            var f = this.files[0];
            if (!f) return;
            var r = new FileReader();
            r.onload = function() {
                try {
                    var data = JSON.parse(r.result);
                    var items = Array.isArray(data) ? data : (data.items || []);
                    window.RealCPA.admin.locationsImport(items).then(function(res) {
                        alert('Импортировано: ' + (res.imported || 0) + ' (создано: ' + (res.created || 0) + ', обновлено: ' + (res.updated || 0) + ')');
                        loadLocations();
                    }).catch(function(err) { alert('Ошибка импорта: ' + (err.message || '')); });
                } catch (e) { alert('Неверный JSON'); }
            };
            r.readAsText(f);
            this.value = '';
        });

        loadLocations();
    })();
    </script>
</body>
</html>
