<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Новый пароль — RealCPA Hub</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-link"></i>
                    <a href="index.html" class="logo-link">RealCPA Hub</a>
                </div>
                <nav class="nav">
                    <a href="index.html" class="nav-link">Главная</a>
                    <a href="login.html" class="nav-link">Войти</a>
                    <a href="register.html" class="nav-link">Регистрация</a>
                </nav>
                <button class="mobile-menu-toggle" id="mobileMenuToggle"><i class="fas fa-bars"></i></button>
            </div>
        </div>
    </header>

    <section class="auth-section">
        <div class="container">
            <div class="auth-container">
                <div class="auth-form active" style="max-width: 420px;">
                    <h2>Новый пароль</h2>
                    <p class="auth-description" id="resetDescription">Введите новый пароль (не менее 6 символов).</p>
                    <div id="resetNoToken" style="display: none;">
                        <p class="auth-message error">Ссылка недействительна или отсутствует. <a href="forgot-password.html">Запросите сброс пароля</a> снова.</p>
                        <p><a href="login.html" class="auth-forgot-link">Вернуться к входу</a></p>
                    </div>
                    <form id="resetForm" style="display: none;">
                        <input type="hidden" id="resetToken" value="">
                        <div class="form-group">
                            <label for="resetPassword">Новый пароль</label>
                            <input type="password" id="resetPassword" required minlength="6" placeholder="Не менее 6 символов">
                        </div>
                        <div class="form-group">
                            <label for="resetPasswordConfirm">Повторите пароль</label>
                            <input type="password" id="resetPasswordConfirm" required minlength="6" placeholder="Повторите пароль">
                        </div>
                        <button type="submit" class="btn btn-primary btn-block" id="resetSubmitBtn">Сохранить пароль</button>
                    </form>
                    <div id="resetMessage" class="auth-message" style="display: none; margin-top: 1rem;"></div>
                    <div id="resetSuccess" style="display: none; margin-top: 1rem;">
                        <p class="auth-message success">Пароль успешно изменён.</p>
                        <a href="login.html" class="btn btn-primary">Войти</a>
                    </div>
                    <p style="margin-top: 1.5rem;" id="resetBackLink">
                        <a href="login.html" class="auth-forgot-link">Вернуться к входу</a>
                    </p>
                </div>
            </div>
        </div>
    </section>

    <div id="footer-placeholder"></div>
    <script src="footer-include.js"></script>
    <script src="api.js"></script>
    <script src="script.js"></script>
    <script>
    (function() {
        var params = new URLSearchParams(window.location.search);
        var token = params.get('token');
        var form = document.getElementById('resetForm');
        var noTokenEl = document.getElementById('resetNoToken');
        var messageEl = document.getElementById('resetMessage');
        var successEl = document.getElementById('resetSuccess');
        var backLinkEl = document.getElementById('resetBackLink');
        var submitBtn = document.getElementById('resetSubmitBtn');

        if (!token || token.length < 10) {
            if (noTokenEl) noTokenEl.style.display = 'block';
            if (form) form.style.display = 'none';
            if (backLinkEl) backLinkEl.style.display = 'none';
        } else {
            var tokenInput = document.getElementById('resetToken');
            if (tokenInput) tokenInput.value = token;
            if (form) form.style.display = 'block';
        }

        if (!form || typeof window.RealCPA === 'undefined') return;

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            var newPassword = (document.getElementById('resetPassword') || {}).value;
            var confirmPassword = (document.getElementById('resetPasswordConfirm') || {}).value;
            var t = (document.getElementById('resetToken') || {}).value;
            if (newPassword !== confirmPassword) {
                if (messageEl) { messageEl.style.display = 'block'; messageEl.className = 'auth-message error'; messageEl.textContent = 'Пароли не совпадают.'; }
                return;
            }
            if (newPassword.length < 6) {
                if (messageEl) { messageEl.style.display = 'block'; messageEl.className = 'auth-message error'; messageEl.textContent = 'Пароль должен быть не короче 6 символов.'; }
                return;
            }
            if (messageEl) { messageEl.style.display = 'none'; }
            if (submitBtn) submitBtn.disabled = true;

            window.RealCPA.auth.resetPassword(t, newPassword)
                .then(function(r) {
                    if (form) form.style.display = 'none';
                    if (successEl) successEl.style.display = 'block';
                    if (backLinkEl) backLinkEl.style.display = 'none';
                })
                .catch(function(err) {
                    if (messageEl) {
                        messageEl.style.display = 'block';
                        messageEl.className = 'auth-message error';
                        messageEl.textContent = err.message || err.payload?.error || 'Ошибка. Ссылка могла истечь — запросите сброс снова.';
                    }
                })
                .finally(function() {
                    if (submitBtn) submitBtn.disabled = false;
                });
        });
    })();
    </script>
</body>
</html>
