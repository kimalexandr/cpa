<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Профиль — RealCPA Hub</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="profile-page">
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-link"></i>
                    <a href="index.html" class="logo-link">RealCPA Hub</a>
                </div>
                <nav class="nav">
                    <a href="index.html" class="nav-link">Главная</a>
                    <a href="offers.html" class="nav-link">Офферы</a>
                    <a href="dashboard-affiliate.html" class="nav-link">Кабинет партнёра</a>
                    <a href="dashboard-supplier.html" class="nav-link">Кабинет поставщика</a>
                    <a href="support.html" class="nav-link">Поддержка</a>
                    <a href="about.html" class="nav-link">О компании</a>
                    <span class="nav-auth nav-auth-guest">
                        <a href="login.html" class="nav-link btn-nav-login">Войти</a>
                        <a href="register.html" class="nav-link btn-nav-register">Регистрация</a>
                    </span>
                    <span class="nav-auth nav-auth-user" style="display:none">
                        <div class="user-block" id="userBlockDropdownTrigger" tabindex="0" role="button" aria-haspopup="true">
                            <span class="user-role-badge nav-role-badge" id="navRoleBadge"></span>
                            <span class="nav-user-short" id="navUserShortName"></span>
                            <span class="user-avatar"><i class="fas fa-user-circle"></i></span>
                            <i class="fas fa-chevron-down user-chevron"></i>
                        </div>
                        <div class="user-dropdown" id="userDropdown" aria-hidden="true">
                            <a href="dashboard.html" class="user-dropdown-item user-dropdown-profile">Профиль</a>
                            <a href="admin/index.html" class="user-dropdown-item" id="navAdminLink" style="display:none">Админка</a>
                            <a href="profile.html" class="user-dropdown-item user-dropdown-settings">Настройки</a>
                            <div class="user-dropdown-divider"></div>
                            <button type="button" class="user-dropdown-item user-dropdown-logout">Выйти</button>
                        </div>
                    </span>
                </nav>
                <button class="mobile-menu-toggle" id="mobileMenuToggle"><i class="fas fa-bars"></i></button>
            </div>
        </div>
    </header>

    <main class="profile-main container">
        <h1 class="profile-page-title">Профиль</h1>

        <div class="profile-cards">
            <!-- Личные данные -->
            <section class="profile-card">
                <h2 class="profile-card-title">Личные данные</h2>
                <div class="profile-card-personal">
                    <div class="profile-avatar" id="profileAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="profile-personal-fields">
                        <div class="profile-field">
                            <span class="profile-field-label">Имя</span>
                            <span class="profile-field-value" id="profileName">—</span>
                        </div>
                        <div class="profile-field">
                            <span class="profile-field-label">Страна, город</span>
                            <span class="profile-field-value" id="profileLocation">Не выбрано</span>
                        </div>
                        <a href="#" class="profile-link" id="profileEditPersonal">Изменить личные данные</a>
                    </div>
                </div>
            </section>

            <!-- Учетная запись -->
            <section class="profile-card">
                <div class="profile-card-head">
                    <h2 class="profile-card-title">Учетная запись</h2>
                    <span class="profile-user-id" id="profileUserId">#—</span>
                </div>
                <div class="profile-account-fields">
                    <div class="profile-field">
                        <span class="profile-field-label">Пароль</span>
                        <a href="#" class="profile-link" id="profilePasswordLink">Изменить пароль</a>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">E-Mail / Логин</span>
                        <span class="profile-field-value" id="profileEmail">—</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">Номер телефона</span>
                        <span class="profile-field-value" id="profilePhone">—</span>
                        <a href="#" class="profile-link profile-link-inline" id="profilePhoneLink">Указать номер телефона</a>
                    </div>
                    <a href="#" class="profile-link profile-link-danger" id="profileDeleteAccount">Удалить аккаунт</a>
                </div>
            </section>

            <!-- Реквизиты для выплат (только для партнёра) -->
            <section class="profile-card" id="profilePayoutSection" style="display: none;">
                <h2 class="profile-card-title">Реквизиты для выплат</h2>
                <p class="auth-description">Укажите реквизиты, на которые нужно переводить деньги (карта, счёт, Яндекс.Кошелёк и т.д.). Они используются при обработке заявок на вывод.</p>
                <div class="form-group">
                    <label for="profilePayoutDetails">Реквизиты</label>
                    <textarea id="profilePayoutDetails" rows="4" placeholder="Например: Сбербанк 1234 5678 9012 3456, Иван И."></textarea>
                </div>
                <button type="button" class="btn btn-primary" id="profileSavePayout">Сохранить реквизиты</button>
            </section>

            <!-- Уведомления -->
            <section class="profile-card">
                <h2 class="profile-card-title">Уведомления</h2>
                <p class="auth-description" style="margin-bottom: 1rem;">Выберите, какие письма и уведомления получать на email.</p>
                <div class="profile-notifications">
                    <div class="profile-notify-row">
                        <span class="profile-notify-label">Присылать новости и акции</span>
                        <label class="profile-toggle">
                            <input type="checkbox" id="notifyNews" class="profile-toggle-input">
                            <span class="profile-toggle-slider"></span>
                        </label>
                    </div>
                    <div class="profile-notify-row">
                        <span class="profile-notify-label">Уведомления системы (обновления, важные сообщения)</span>
                        <label class="profile-toggle">
                            <input type="checkbox" id="notifySystem" class="profile-toggle-input">
                            <span class="profile-toggle-slider"></span>
                        </label>
                    </div>
                    <div class="profile-notify-row">
                        <span class="profile-notify-label">Письма об одобрении или отклонении заявок на офферы</span>
                        <label class="profile-toggle">
                            <input type="checkbox" id="notifyParticipation" class="profile-toggle-input">
                            <span class="profile-toggle-slider"></span>
                        </label>
                    </div>
                    <div class="profile-notify-row">
                        <span class="profile-notify-label">Письма о выплатах (заявка выполнена)</span>
                        <label class="profile-toggle">
                            <input type="checkbox" id="notifyPayouts" class="profile-toggle-input">
                            <span class="profile-toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </section>
        </div>

        <!-- Модалка редактирования личных данных -->
        <div class="modal profile-modal" id="profileEditModal">
            <div class="modal-content profile-modal-content">
                <h3>Изменить личные данные</h3>
                <form id="profileEditForm">
                    <div class="form-group">
                        <label for="editName">Имя</label>
                        <input type="text" id="editName" class="form-control" placeholder="Имя Фамилия">
                    </div>
                    <div class="form-group">
                        <label for="editCountry">Страна</label>
                        <input type="text" id="editCountry" class="form-control" placeholder="Страна">
                    </div>
                    <div class="form-group">
                        <label for="editCity">Город</label>
                        <input type="text" id="editCity" class="form-control" placeholder="Город">
                    </div>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                    <button type="button" class="btn btn-secondary profile-modal-cancel">Отмена</button>
                </form>
            </div>
        </div>

        <!-- Модалка смены пароля -->
        <div class="modal profile-modal" id="profilePasswordModal">
            <div class="modal-content profile-modal-content">
                <h3>Изменить пароль</h3>
                <form id="profilePasswordForm">
                    <div class="form-group">
                        <label for="currentPassword">Текущий пароль</label>
                        <input type="password" id="currentPassword" class="form-control" required autocomplete="current-password">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">Новый пароль</label>
                        <input type="password" id="newPassword" class="form-control" required minlength="6" autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label for="newPasswordConfirm">Повторите новый пароль</label>
                        <input type="password" id="newPasswordConfirm" class="form-control" required minlength="6" autocomplete="new-password">
                    </div>
                    <p id="passwordFormError" class="auth-message error" style="display:none;"></p>
                    <button type="submit" class="btn btn-primary">Изменить пароль</button>
                    <button type="button" class="btn btn-secondary profile-modal-cancel" data-close="profilePasswordModal">Отмена</button>
                </form>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>
    <script src="footer-include.js"></script>
    <script src="api.js"></script>
    <script src="script.js"></script>
    <script>
    (function() {
        if (typeof window.RealCPA === 'undefined' || !window.RealCPA.isLoggedIn()) {
            window.location.href = 'login.html?redirect=' + encodeURIComponent('profile.html');
            return;
        }

        var modal = document.getElementById('profileEditModal');
        var editForm = document.getElementById('profileEditForm');
        var btnCancel = document.querySelector('.profile-modal-cancel');

        function loadProfile() {
            window.RealCPA.me().then(function(user) {
                document.getElementById('profileName').textContent = user.name || user.email || '—';
                var loc = [user.country, user.city].filter(Boolean).join(', ') || 'Не выбрано';
                document.getElementById('profileLocation').textContent = loc;
                document.getElementById('profileEmail').textContent = user.email || '—';
                document.getElementById('profilePhone').textContent = user.phone || '—';
                var idShort = user.id ? '#' + String(user.id).slice(-7) : '#—';
                document.getElementById('profileUserId').textContent = idShort;
                document.getElementById('editName').value = user.name || '';
                document.getElementById('editCountry').value = user.country || '';
                document.getElementById('editCity').value = user.city || '';
            }).catch(function() {
                document.getElementById('profileName').textContent = 'Ошибка загрузки';
            });
        }

        document.getElementById('profileEditPersonal').addEventListener('click', function(e) {
            e.preventDefault();
            if (modal) modal.classList.add('active');
        });
        if (btnCancel && modal) btnCancel.addEventListener('click', function() { modal.classList.remove('active'); });
        if (modal) modal.addEventListener('click', function(e) { if (e.target === modal) modal.classList.remove('active'); });

        if (editForm) {
            editForm.addEventListener('submit', function(e) {
                e.preventDefault();
                var data = {
                    name: document.getElementById('editName').value.trim() || undefined,
                    country: document.getElementById('editCountry').value.trim() || undefined,
                    city: document.getElementById('editCity').value.trim() || undefined
                };
                window.RealCPA.patchMe(data).then(function(user) {
                    document.getElementById('profileName').textContent = user.name || user.email || '—';
                    var loc = [user.country, user.city].filter(Boolean).join(', ') || 'Не выбрано';
                    document.getElementById('profileLocation').textContent = loc;
                    if (modal) modal.classList.remove('active');
                }).catch(function(err) {
                    alert(err.message || err.payload?.error || 'Ошибка сохранения');
                });
            });
        }

        var passwordModal = document.getElementById('profilePasswordModal');
        var passwordForm = document.getElementById('profilePasswordForm');
        document.getElementById('profilePasswordLink').addEventListener('click', function(e) {
            e.preventDefault();
            if (passwordModal) {
                passwordModal.classList.add('active');
                document.getElementById('passwordFormError').style.display = 'none';
                if (passwordForm) passwordForm.reset();
            }
        });
        document.querySelectorAll('[data-close="profilePasswordModal"]').forEach(function(btn) {
            btn.addEventListener('click', function() { if (passwordModal) passwordModal.classList.remove('active'); });
        });
        if (passwordModal) passwordModal.addEventListener('click', function(e) { if (e.target === passwordModal) passwordModal.classList.remove('active'); });
        if (passwordForm) {
            passwordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                var newPwd = document.getElementById('newPassword').value;
                var confirmPwd = document.getElementById('newPasswordConfirm').value;
                var errEl = document.getElementById('passwordFormError');
                if (newPwd !== confirmPwd) {
                    errEl.textContent = 'Новый пароль и повтор не совпадают.';
                    errEl.style.display = 'block';
                    return;
                }
                errEl.style.display = 'none';
                window.RealCPA.changePassword(document.getElementById('currentPassword').value, newPwd)
                    .then(function() {
                        if (passwordModal) passwordModal.classList.remove('active');
                        passwordForm.reset();
                        alert('Пароль успешно изменён.');
                    })
                    .catch(function(err) {
                        errEl.textContent = err.message || (err.payload && err.payload.error) || 'Ошибка смены пароля';
                        errEl.style.display = 'block';
                    });
            });
        }
        document.getElementById('profilePhoneLink').addEventListener('click', function(e) {
            e.preventDefault();
            alert('Указание телефона будет доступно в следующей версии.');
        });
        document.getElementById('profileDeleteAccount').addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('Вы уверены, что хотите удалить аккаунт? Это действие необратимо.')) {
                alert('Удаление аккаунта пока не реализовано. Обратитесь в поддержку.');
            }
        });

        function setNotifyFromProfile(profile) {
            var ids = ['notifyNews', 'notifySystem', 'notifyParticipation', 'notifyPayouts'];
            var keys = ['notifyNews', 'notifySystem', 'notifyParticipation', 'notifyPayouts'];
            keys.forEach(function(key, i) {
                var el = document.getElementById(ids[i]);
                if (!el) return;
                el.checked = profile && profile[key] !== false;
            });
        }
        function saveNotifyToProfile() {
            if (window.RealCPA.getRole() !== 'affiliate') return;
            window.RealCPA.patchAffiliateProfile({
                notifyNews: document.getElementById('notifyNews').checked,
                notifySystem: document.getElementById('notifySystem').checked,
                notifyParticipation: document.getElementById('notifyParticipation').checked,
                notifyPayouts: document.getElementById('notifyPayouts').checked
            }).catch(function() {});
        }
        if (window.RealCPA.getRole() === 'affiliate') {
            var payoutSection = document.getElementById('profilePayoutSection');
            var payoutDetailsEl = document.getElementById('profilePayoutDetails');
            var savePayoutBtn = document.getElementById('profileSavePayout');
            if (payoutSection) payoutSection.style.display = 'block';
            window.RealCPA.getAffiliateProfile().then(function(p) {
                setNotifyFromProfile(p);
                if (payoutDetailsEl && p && p.payoutDetails != null) payoutDetailsEl.value = p.payoutDetails;
            }).catch(function() {
                setNotifyFromProfile(null);
            });
            if (savePayoutBtn && payoutDetailsEl) {
                savePayoutBtn.addEventListener('click', function() {
                    savePayoutBtn.disabled = true;
                    window.RealCPA.patchAffiliateProfile({ payoutDetails: payoutDetailsEl.value.trim() || null }).then(function() {
                        savePayoutBtn.disabled = false;
                        alert('Реквизиты сохранены.');
                    }).catch(function(err) {
                        savePayoutBtn.disabled = false;
                        alert(err.message || err.payload && err.payload.error || 'Ошибка сохранения');
                    });
                });
            }
        } else {
            setNotifyFromProfile(null);
        }
        ['notifyNews', 'notifySystem', 'notifyParticipation', 'notifyPayouts'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.addEventListener('change', saveNotifyToProfile);
        });

        loadProfile();
    })();
    </script>
</body>
</html>
