# Чеклист полноценного запуска RealCPA Hub

Что нужно сделать, чтобы площадка была готова к работе: безопасность, конфигурация, контент и операции.

---

## 1. Инфраструктура и деплой

### 1.1 Секреты GitHub Actions
В репозитории уже настроен деплой на VPS при пуше в `main`. В **GitHub → Settings → Secrets and variables → Actions** должны быть:
- `VPS_HOST` — IP или домен сервера (например `155.212.221.220`)
- `VPS_USER` — пользователь SSH (например `root`)
- `VPS_SSH_KEY` — приватный SSH-ключ для доступа к серверу

### 1.2 Файл `.env` на сервере
При первом деплое в `/root/cpa/backend/` копируется `.env.example` в `.env`. **Обязательно отредактируйте `.env` на сервере** (по SSH) и задайте:

| Переменная | Назначение |
|------------|------------|
| `DATABASE_URL` | Уже подставляется из docker-compose (`postgresql://realcpa:realcpa@db:5432/realcpa`) — можно не менять, если используете стандартный compose |
| `JWT_SECRET` | **Критично.** Длинная случайная строка (например `openssl rand -hex 32`). Не оставляйте значение из .env.example |
| `API_BASE_URL` или `FRONTEND_URL` | Публичный URL сайта, например `https://ваш-домен.ru` — для писем и трекинг-ссылок |
| `RESTORE_ADMIN_SECRET` | Опционально. Секрет для одноразового вызова `POST /api/restore-admin` (восстановление админа и офферов) |

После смены `.env` перезапустите приложение:  
`cd /root/cpa/backend && docker-compose up -d --build`

### 1.3 HTTPS (настоятельно рекомендуется)
Сейчас Nginx в деплое слушает только порт 80 (HTTP). Для продакшена нужен HTTPS:
- Установите сертификат (например Let's Encrypt): `apt install certbot python3-certbot-nginx && certbot --nginx -d ваш-домен.ru`
- Или вручную настройте в `/etc/nginx/sites-available/cpa` блок `server { listen 443 ssl; ... }` с `ssl_certificate` и `ssl_certificate_key`
- В `.env` укажите `FRONTEND_URL=https://ваш-домен.ru`

---

## 2. Безопасность

- [ ] **JWT_SECRET** — уникальный и длинный, не из .env.example  
- [ ] **Пароль БД** — в docker-compose по умолчанию `realcpa:realcpa`; для продакшена лучше сменить и задать `POSTGRES_USER`/`POSTGRES_PASSWORD`, затем обновить `DATABASE_URL` в `.env`  
- [ ] **RESTORE_ADMIN_SECRET** — если использовали для восстановления админа, можно удалить из `.env` или оставить (без правильного заголовка эндпоинт не сработает)  
- [ ] Ограничить доступ к админке (например по IP или VPN), если нужно — на уровне Nginx  

---

## 3. Первый запуск и данные

### 3.0 Миграции БД (если каталог офферов не грузится)
Если в каталоге офферов появляется ошибка «Обновите БД: выполните npx prisma db push…», на сервере нужно применить миграции и при необходимости сид:
```bash
cd /root/cpa/backend && docker-compose run --rm app npm run db:migrate
# затем для тестовых офферов и админа:
docker-compose run --rm app npm run db:seed
```
Локально (из папки `backend`): `npx prisma migrate deploy` или `npx prisma db push`, затем `npm run db:seed`.  
Для дерева регионов в модалке «Выбор региона» дополнительно выполните `npm run db:seed-locations` (после миграций).

### 3.1 Админ и каталог офферов
После деплоя на сервере может не быть ни админа, ни офферов. Один из вариантов:

**Вариант А.** Вызвать эндпоинт восстановления (если в `.env` задан `RESTORE_ADMIN_SECRET`):
```bash
curl -X POST "https://ваш-домен.ru/api/restore-admin" \
  -H "X-Restore-Secret: ВАШ_RESTORE_ADMIN_SECRET" \
  -H "Content-Type: application/json"
```
Создаётся админ `ya@ya.ru` / пароль `kAlkiujn7` и 6 тестовых офферов в каталоге.

**Вариант Б.** Зайти на сервер и выполнить полный сид:
```bash
cd /root/cpa/backend && docker-compose run --rm app npm run db:seed
```
Появится админ, поставщик, аффилиат, офферы и тестовые данные.

### 3.2 Смена пароля админа
После первого входа смените пароль админа в разделе «Профиль» / «Настройки».

---

## 4. Email (письма пользователям)

Письма (сброс пароля, приветствие, одобрение/отклонение заявок, выплаты) отправляются только при настроенном SMTP. В `.env` на сервере добавьте:

| Переменная | Пример |
|------------|--------|
| `MAIL_HOST` | `smtp.yandex.ru` или ваш SMTP |
| `MAIL_PORT` | `587` или `465` |
| `MAIL_USER` | Логин SMTP |
| `MAIL_PASS` | Пароль или пароль приложения |
| `MAIL_FROM` | `noreply@ваш-домен.ru` |
| `FRONTEND_URL` | `https://ваш-домен.ru` (для ссылок в письмах) |

Без SMTP регистрация и сброс пароля работают, но пользователи не получат писем.

---

## 5. Контент и юридические страницы

- **Политика конфиденциальности** (`policy.html`) и **Пользовательское соглашение** (`terms.html`) — уже есть базовый текст; при необходимости доработайте под вашу юр. лицо и домен.  
- **О компании** (`about.html`), **Контакты** (`contacts.html`) — заполните реальными данными.  
- **Поддержка** (`support.html`) — укажите способ связи (email, форма, мессенджер).  
- В футере и на страницах замените заглушки на актуальные ссылки и реквизиты.

---

## 6. Операционные задачи после запуска

- **Модерация офферов:** черновые офферы от поставщиков в админке («Офферы») переводите в статус «Активный», чтобы они появились в каталоге.  
- **Заявки партнёров:** в разделе «Модерация» одобряйте или отклоняйте заявки аффилиатов на подключение к офферам (одобрение может делать и поставщик в своём кабинете).  
- **Лиды/события:** постбек лидов/продаж идёт на `POST /api/events` (см. документацию API; токен трекинг-ссылки передаётся в теле запроса).  
- **Выплаты:** аффилиат создаёт заявку на вывод; в админке («Финансы») можно переводить статус в «Выплачено» — пользователю уйдёт письмо (если настроен SMTP).

---

## 7. Резервное копирование БД

Рекомендуется настроить регулярный бэкап PostgreSQL (данные в volume `pgdata`). Пример с сервера:
```bash
docker-compose exec db pg_dump -U realcpa realcpa > backup_$(date +%Y%m%d).sql
```
Сохраняйте дампы на отдельный сервер или в облако.

---

## 8. Краткий минимум для «запустили и работаем»

1. Задать в GitHub секреты `VPS_HOST`, `VPS_USER`, `VPS_SSH_KEY`.  
2. На VPS в `/root/cpa/backend/.env` прописать **JWT_SECRET** (и при необходимости **API_BASE_URL** / **FRONTEND_URL**).  
3. После деплоя один раз вызвать `POST /api/restore-admin` с секретом или выполнить `npm run db:seed` на сервере.  
4. Войти как админ, сменить пароль, при желании включить HTTPS и настроить SMTP.  
5. Заполнить контакты, о компании и поддержку; при необходимости доработать политику и соглашение.

После этого площадка готова к регистрации поставщиков и партнёров и к приёму трафика.

---

## 9. Функциональность CPA для товаров (полный цикл)

### 9.1 Постбек конверсий (лид/продажа)
Поставщик или его система должны отправлять конверсии на API, чтобы партнёрам начислялся баланс.

**POST** `/api/events`  
Тело (JSON):
- `token` — токен трекинг-ссылки (из кабинета партнёра «Мои подключения») **или** `tracking_link_id`
- `event_type` — `"lead"` или `"sale"`
- `amount` — сумма в рублях (опционально; для лида подставится ставка оффера)
- `external_id` — внешний ID заказа (опционально)

Пример:
```json
{ "token": "tk-xxxx-yyyy", "event_type": "sale", "amount": 500 }
```

Событие создаётся со статусом **pending**. Деньги партнёру не начисляются, пока конверсия не одобрена.

### 9.2 Модерация лидов и продаж
- **Поставщик:** раздел «Лиды и продажи» в кабинете — список событий по своим офферам, кнопки «Одобрить» / «Отклонить».
- **Админ:** раздел «Модерация» — таблица лидов/продаж, те же действия.

После одобрения сумма учитывается в балансе партнёра с учётом **холда** оффера (поле `hold_days`): деньги становятся доступны к выводу только после истечения холда.

### 9.3 Модели оплаты (CPL / CPA)
- **CPL** — в баланс идут одобренные события типа **lead** по ставке оффера.
- **CPA** и **RevShare** — в баланс идут одобренные события типа **sale** по сумме из постбека или по ставке оффера.

Минимальная сумма вывода — 1000 ₽. Выплаты обрабатываются вручную в админке (Финансы → смена статуса на «Выплачено»).

### 9.4 Заявки партнёров на офферы
- **Поставщик:** «Заявки партнёров» — одобрение/отклонение; при одобрении создаётся трекинг-ссылка и отправляется письмо партнёру.
- **Админ:** «Модерация» — те же действия для любых заявок.
