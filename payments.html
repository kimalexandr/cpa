<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Выплаты — RealCPA Hub</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="dashboard-page">
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-link"></i>
                    <a href="index.html" class="logo-link">RealCPA Hub</a>
                </div>
                <nav class="nav">
                    <a href="index.html" class="nav-link">Главная</a>
                    <a href="offers.html" class="nav-link">Офферы</a>
                    <a href="dashboard-supplier.html" class="nav-link active">Кабинет поставщика</a>
                    <a href="support.html" class="nav-link">Поддержка</a>
                    <a href="about.html" class="nav-link">О компании</a>
                    <span class="nav-auth nav-auth-guest">
                        <a href="login.html" class="nav-link btn-nav-login">Войти</a>
                        <a href="register.html" class="nav-link btn-nav-register">Регистрация</a>
                    </span>
                    <span class="nav-auth nav-auth-user" style="display:none">
                        <div class="user-block" id="userBlockDropdownTrigger" tabindex="0" role="button" aria-haspopup="true">
                            <span class="user-role-badge nav-role-badge" id="navRoleBadge"></span>
                            <span class="nav-user-short" id="navUserShortName"></span>
                            <span class="user-avatar"><i class="fas fa-user-circle"></i></span>
                            <i class="fas fa-chevron-down user-chevron"></i>
                        </div>
                        <div class="user-dropdown" id="userDropdown" aria-hidden="true">
                            <a href="dashboard.html" class="user-dropdown-item user-dropdown-profile">Профиль</a>
                            <a href="admin/index.html" class="user-dropdown-item" id="navAdminLink" style="display:none">Админка</a>
                            <a href="#" class="user-dropdown-item user-dropdown-settings">Настройки</a>
                            <div class="user-dropdown-divider"></div>
                            <button type="button" class="user-dropdown-item user-dropdown-logout">Выйти</button>
                        </div>
                    </span>
                </nav>
                <button class="mobile-menu-toggle" id="mobileMenuToggle"><i class="fas fa-bars"></i></button>
            </div>
        </div>
    </header>

    <div class="dashboard-layout">
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <a href="dashboard-supplier.html" class="sidebar-link">
                    <i class="fas fa-home"></i>
                    <span>Главная</span>
                </a>
                <a href="dashboard-supplier-offers.html" class="sidebar-link sidebar-supplier-only">
                    <i class="fas fa-briefcase"></i>
                    <span>Мои офферы</span>
                </a>
                <a href="create-offer.html" class="sidebar-link sidebar-supplier-only">
                    <i class="fas fa-plus-circle"></i>
                    <span>Создать оффер</span>
                </a>
                <a href="dashboard-supplier-requests.html" class="sidebar-link sidebar-supplier-only">
                    <i class="fas fa-user-check"></i>
                    <span>Заявки партнёров</span>
                </a>
                <a href="analytics.html" class="sidebar-link">
                    <i class="fas fa-chart-line"></i>
                    <span>Аналитика</span>
                </a>
                <a href="payments.html" class="sidebar-link active sidebar-payments-label">
                    <i class="fas fa-wallet"></i>
                    <span>Расходы на партнёров</span>
                </a>
            </nav>
        </aside>

        <main class="dashboard-main">
            <div class="dashboard-header">
                <h1>Выплаты и Финансы</h1>
            </div>

            <!-- Блок аффилиата: баланс и выплаты -->
            <div id="paymentsAffiliateBlock" style="display: none;">
                <div class="balance-section">
                    <div class="balance-card">
                        <h2>Доступно к выводу</h2>
                        <p class="balance-amount" id="balanceAvailable">0 ₽</p>
                        <p class="balance-note">Заработано: <span id="balanceEarned">0</span> ₽ · Уже выведено: <span id="balancePaidOut">0</span> ₽</p>
                        <p class="balance-note">Минимальная сумма вывода: <span id="balanceMin">1000</span> ₽</p>
                    </div>
                    <div class="balance-actions">
                        <button class="btn btn-primary" id="withdrawBtn">
                            <i class="fas fa-arrow-up"></i>
                            Вывести средства
                        </button>
                    </div>
                </div>
                <div class="payment-methods">
                    <h2>Методы выплат</h2>
                    <p class="auth-description">Реквизиты для выплат можно указать в <a href="profile.html">профиле</a>. Выплаты обрабатываются вручную администратором.</p>
                </div>
                <div class="transactions-section">
                    <h2>История выплат</h2>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Дата заявки</th>
                                    <th>Сумма</th>
                                    <th>Статус</th>
                                </tr>
                            </thead>
                            <tbody id="payoutsTableBody">
                                <tr><td colspan="3" style="color: #64748b;">Загрузка…</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Блок поставщика: расходы на партнёров -->
            <div id="paymentsSupplierBlock" style="display: none;">
                <div class="balance-section">
                    <div class="balance-card">
                        <h2>Расходы на партнёров</h2>
                        <p class="balance-amount" id="supplierTotalPayout">0 ₽</p>
                        <p class="balance-note">Сумма начислений по офферам за одобренные заказы.</p>
                    </div>
                </div>
            </div>

            <!-- Модальное окно вывода (только для аффилиата) -->
            <div class="modal" id="withdrawModal">
                <div class="modal-content">
                    <span class="modal-close" onclick="closeModal('withdrawModal')">&times;</span>
                    <h2>Вывод средств</h2>
                    <form id="withdrawForm">
                        <div class="form-group">
                            <label for="withdrawAmount">Сумма (мин. <span id="withdrawMinLabel">1000</span> ₽)</label>
                            <input type="number" id="withdrawAmount" name="amount" min="1000" step="100" required placeholder="1000">
                        </div>
                        <p id="withdrawError" class="auth-message error" style="display: none;"></p>
                        <button type="submit" class="btn btn-primary btn-block" id="withdrawSubmitBtn">Отправить заявку</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <div id="footer-placeholder"></div>
    <script src="footer-include.js"></script>
    <script src="api.js"></script>
    <script src="script.js"></script>
    <script>
    (function() {
        if (typeof window.RealCPA === 'undefined' || !window.RealCPA.isLoggedIn()) {
            window.location.href = 'login.html?redirect=' + encodeURIComponent('payments.html');
            return;
        }
        var role = window.RealCPA.getRole();
        var affiliateBlock = document.getElementById('paymentsAffiliateBlock');
        var supplierBlock = document.getElementById('paymentsSupplierBlock');

        if (role === 'affiliate') {
            document.querySelectorAll('.sidebar-supplier-only').forEach(function(el) { el.style.display = 'none'; });
            var mainLink = document.querySelector('.sidebar-nav a[href="dashboard-supplier.html"]');
            if (mainLink) {
                mainLink.href = 'dashboard-affiliate.html';
                mainLink.insertAdjacentHTML('afterend',
                    '<a href="offers.html" class="sidebar-link"><i class="fas fa-th-large"></i><span>Каталог офферов</span></a>' +
                    '<a href="dashboard-affiliate-connections.html" class="sidebar-link"><i class="fas fa-link"></i><span>Мои подключения</span></a>'
                );
            }
            var paymentsLabel = document.querySelector('.sidebar-payments-label span');
            if (paymentsLabel) paymentsLabel.textContent = 'Выплаты';
            if (affiliateBlock) affiliateBlock.style.display = 'block';

            function fmtNum(n) { return Number(n).toLocaleString('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 2 }); }
            function fmtDate(d) {
                var x = new Date(d);
                return x.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            }
            function statusLabel(s) {
                if (s === 'paid') return 'Выплачено';
                if (s === 'processing') return 'В обработке';
                if (s === 'pending') return 'Ожидает';
                if (s === 'canceled') return 'Отменено';
                return s;
            }

            function loadBalance() {
                window.RealCPA.affiliate.balance().then(function(b) {
                    var el;
                    if (el = document.getElementById('balanceAvailable')) el.textContent = fmtNum(b.availableBalance) + ' ₽';
                    if (el = document.getElementById('balanceEarned')) el.textContent = fmtNum(b.earned);
                    if (el = document.getElementById('balancePaidOut')) el.textContent = fmtNum(b.paidOut);
                    if (el = document.getElementById('balanceMin')) el.textContent = String(b.minPayout || 1000);
                    if (el = document.getElementById('withdrawMinLabel')) el.textContent = String(b.minPayout || 1000);
                    if (el = document.getElementById('withdrawAmount')) el.max = b.availableBalance;
                }).catch(function() {
                    if (affiliateBlock) affiliateBlock.querySelector('.balance-amount').textContent = '—';
                });
            }
            function loadPayouts() {
                var tbody = document.getElementById('payoutsTableBody');
                if (!tbody) return;
                window.RealCPA.affiliate.getPayouts().then(function(list) {
                    if (!list || !list.length) {
                        tbody.innerHTML = '<tr><td colspan="3" style="color: #64748b;">Пока нет выплат</td></tr>';
                        return;
                    }
                    tbody.innerHTML = list.map(function(p) {
                        var amount = Number(p.amount);
                        return '<tr><td>' + fmtDate(p.createdAt) + '</td><td>' + fmtNum(amount) + ' ₽</td><td>' + statusLabel(p.status) + '</td></tr>';
                    }).join('');
                }).catch(function() {
                    tbody.innerHTML = '<tr><td colspan="3" style="color: #64748b;">Не удалось загрузить историю</td></tr>';
                });
            }

            loadBalance();
            loadPayouts();

            var withdrawForm = document.getElementById('withdrawForm');
            var withdrawError = document.getElementById('withdrawError');
            var withdrawSubmitBtn = document.getElementById('withdrawSubmitBtn');
            if (withdrawForm) {
                withdrawForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    var amountEl = document.getElementById('withdrawAmount');
                    var amount = amountEl ? parseFloat(amountEl.value) : 0;
                    if (withdrawError) { withdrawError.style.display = 'none'; withdrawError.textContent = ''; }
                    if (withdrawSubmitBtn) withdrawSubmitBtn.disabled = true;
                    window.RealCPA.affiliate.requestPayout(amount).then(function() {
                        closeModal('withdrawModal');
                        if (amountEl) amountEl.value = '';
                        loadBalance();
                        loadPayouts();
                    }).catch(function(err) {
                        if (withdrawError) {
                            withdrawError.textContent = err.message || err.payload && err.payload.error || 'Ошибка запроса';
                            withdrawError.style.display = 'block';
                        }
                    }).finally(function() {
                        if (withdrawSubmitBtn) withdrawSubmitBtn.disabled = false;
                    });
                });
            }
        } else if (role === 'supplier') {
            if (supplierBlock) supplierBlock.style.display = 'block';
            window.RealCPA.supplier.stats().then(function(s) {
                var el = document.getElementById('supplierTotalPayout');
                if (el) el.textContent = Number(s.totalPayout || 0).toLocaleString('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) + ' ₽';
            }).catch(function() {});
        }
    })();
    </script>
</body>
</html>